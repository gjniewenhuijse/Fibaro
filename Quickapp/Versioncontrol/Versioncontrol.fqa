{"name":"Versioncontrol","type":"com.fibaro.genericDevice","apiVersion":"1.2","initialProperties":{"viewLayout":{"$jason":{"body":{"header":{"style":{"height":"0"},"title":"quickApp_device_350"},"sections":{"items":[{"components":[{"name":"label_version","style":{"weight":"1.2"},"text":"version info","type":"label","visible":true},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"},{"components":[{"components":[{"name":"button_version_check","style":{"weight":"0.50"},"text":"Version check","type":"button","visible":true},{"name":"button_update_qa","style":{"weight":"0.50"},"text":"Update QA","type":"button","visible":true}],"style":{"weight":"1.2"},"type":"horizontal"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"}]}},"head":{"title":"quickApp_device_350"}}},"uiCallbacks":[{"callback":"btn_versionCheck","eventType":"onReleased","name":"button_version_check"},{"callback":"btn_updateQA","eventType":"onReleased","name":"button_update_qa"}],"quickAppVariables":[],"typeTemplateInitialized":true},"initialInterfaces":[],"files":[{"name":"main","isMain":true,"isOpen":false,"content":"_VERSION = \"1.1\"\n_VERSIONDATE = \"17.1.2024\"\n_VERSION_MAIN = \"1.1\"\n_VERSIONDATE_MAIN = \"17.1.2024\"\n__TAG = \"QA_VERSIONCONTROL_MAIN_\" .. plugin.mainDeviceId\n_APP = \"https://raw.githubusercontent.com/gjniewenhuijse/Fibaro/main/Quickapp/Versioncontrol\"\n_VF = _APP..'/Version.lua'\n\nfunction QuickApp:btn_versionCheck()\n    --nowTime = os.date('%d-%m-%y %H:%M:%S')\n    net.HTTPClient():request(_VF,{options={method='GET',checkCertificate=false,timeout=3000},\n    success=function(c)\n        if c.status==200 then \n            oVersion = json.decode(c.data).version\n            self:updateView(\"label_version\", \"text\", (\"huidige versie:\".._VERSION..\" online versie:\"..oVersion))\n    \telse \n            self:debug(\"niet succesvol1: \"..c.status) \n\t\tend\n    end,\n    error=function(c)\n        self:debug(\"niet succesvol2:\"..c) \n    end})\nend\n\nfunction QuickApp:btn_updateQA()\n    --https://forum.fibaro.com/topic/67336-modify-a-quickapp-from-one-single-json-table/\n\n    -- load new quickapp\n    net.HTTPClient():request(_VF,{options={method='GET',checkCertificate=false,timeout=3000},\n    success=function(c)\n        if c.status==200 then\n            url = _APP..'/'..json.decode(c.data).file\n            --self:debug(url) \n\n            net.HTTPClient():request(url,{options={method='GET',checkCertificate=false,timeout=20000},success=function(c)\n                if c.status==200 then \n                    -- check existing files\n                    local oldMap, newMap = {}, {}\n                    local currFiles = api.get(\"/quickApp/\" .. plugin.mainDeviceId .. \"/files\")\n                    if currFiles then \n                        for _, f in ipairs(currFiles) do oldMap[f.name] = f end\n                    end\n                    --self:debug('curfiles:'..json.encode(currFiles))\n\n                    -- get new files\n                    files = json.decode(c.data).files\n\n                    for _, f in ipairs(files) do newMap[f.name] = f end\n                    --self:debug('newmap:'..json.encode(oldMap))\n\n                    -- create new files\n                    for newF, d in pairs(newMap) do\n                        if not oldMap[newF] then\n                            self:debug(\"Creating file:\", newF)\n                            local stat, res = api.post(\"/quickApp/\" .. plugin.mainDeviceId .. \"/files\", d)\n                            if not stat then\n                                self:debug(\"Error creating QA file: \"..newF..\" \"..res)\n                            end\n                        end\n                    end\n\n                    -- updating existing files\n                    local stat, res = api.put(\"/quickApp/\" .. plugin.mainDeviceId .. \"/files\", files)\n                    if not stat then\n                        self:debug(\"Error updating QA files: \"..res)\n                    end\n\n                    -- deleting old files\n                    for oldF, _ in pairs(oldMap) do\n                        if not newMap[oldF] then\n                            --self:debug(\"Deleting file2: \", oldF)\n                            api.delete(\"/quickApp/\" .. plugin.mainDeviceId .. \"/files/\" .. oldF)\n                        end\n                    end\n\n                    -- updating uiCallbacks, viewLayout, and optional quickAppVariables\n                    curprop = json.decode(c.data).initialProperties\n                    updateQvs = false -- true werkt niet als er geen variabelen zijn, maar nieuwe toevoegen of bestaande overschrijven op deze manier is sowieso geen goed idee. Altijd via de code aanmaken als ze niet bestaan.\n                    local stat, res = api.put(\"/devices/\" .. plugin.mainDeviceId, {\n                        properties = {\n                            uiCallbacks = curprop.uiCallbacks,\n                            viewLayout = curprop.viewLayout,\n                            quickAppVariables = updateQvs and curprop.quickAppVariables or nil\n                        }\n                    })\n                    if not stat then\n                        self:debug(\"error updating QA props: \"..res)\n                    else\n                        self:debug(\"updating QA props: \"..res)\n                    end\n                    \n                    self:debug(\"QA updated: \" .. plugin.mainDeviceId)\n                        \n                else \n                    self:debug(\"fout tijdens installatie 2: \"..c.status)\n                end \n            end\n            ,error=function(c)\n                self:debug(\"fout tijdens installatie 3\")\n            end})\n        end\n    end\n    ,error=function(c)\n        self:debug(\"fout tijdens ophalen source file\")\n    end})\nend\n\nfunction QuickApp:onInit()\n    self:debug(\"onInit version control\") \nend\n"},{"name":"lib","isMain":false,"isOpen":true,"content":"_VERSION_LIB = \"1.1\"\r\n_VERSIONDATE_LIB = \"17.1.2024\"\r\n\r\nfunction QuickApp:test(iInput)\r\n    self:debug(_VERSION_LIB..' input: '..iInput)\r\nend"}]}
